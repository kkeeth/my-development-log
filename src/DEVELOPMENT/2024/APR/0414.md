# 0414

## LOGS

- PWA with firebase Messaging ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚ã‚„ã‚‹
  - æ˜¨æ™©ã‚„ã£ãŸã®ã§ç¶šãã‹ã‚‰
  - `src/sw.ts` ã‚’æ›¸ã„ã¦ï¼Œ`public/firebase-messaging-sw.js` ã« `esbuild` ã‚’ç”¨ã„ã¦ãƒ“ãƒ«ãƒ‰
    - ãŸã ï¼Œ `vite` ã¨ã¯åˆ¥ã§å‹•ã‹ã—ã¦ã„ã‚‹ã®ã§ï¼Œ `vite` ã¨ã®é€£æºãŒã§ãã¦ã„ãªã„
    - ã¤ã¾ã‚Šï¼Œ`import.meta.env.XXX` ãŒä½¿ãˆãªã„
    - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ä½¿ã£ãŸã‚Šï¼Œ`define` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¤ã‘ãŸã‚Šã—ã¦ã¿ãŸãŒï¼Œã ã‚ -> undefined `import.meta`
  - ã¨ã„ã†ã“ã¨ã§ï¼Œçµå±€åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ã—ã¦ï¼Œ`esbuild-sw.js` ã‚’æ›¸ã„ã¦ï¼Œãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„ã—ãŸ
    ```js
    import esbuild from 'esbuild';
    import dotenv from 'dotenv';

    // .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’ãƒ­ãƒ¼ãƒ‰
    dotenv.config();

    esbuild.build({
      entryPoints: ['src/sw.ts'],
      outfile: 'public/firebase-messaging-sw.js',
      bundle: true,
      minify: true,
      sourcemap: false,
      define: {
        'process.env.VITE_FIREBASE_API_KEY': JSON.stringify(process.env.VITE_FIREBASE_API_KEY),
        'process.env.VITE_FIREBASE_AUTH_DOMAIN': JSON.stringify(process.env.VITE_FIREBASE_AUTH_DOMAIN),
        'process.env.VITE_FIREBASE_PROJECT_ID': JSON.stringify(process.env.VITE_FIREBASE_PROJECT_ID),
        'process.env.VITE_FIREBASE_STORAGE_BUCKET': JSON.stringify(process.env.VITE_FIREBASE_STORAGE_BUCKET),
        'process.env.VITE_FIREBASE_MESSAGING_SENDER_ID': JSON.stringify(process.env.VITE_FIREBASE_MESSAGING_SENDER_ID),
        'process.env.VITE_FIREBASE_APP_ID': JSON.stringify(process.env.VITE_FIREBASE_APP_ID),
      },
      platform: 'browser',
      target: ['esnext']
    }).catch(() => process.exit(1));
    ```
  - ã“ã‚Œã§OK
  - ã‚ã¨ã¯ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ `> node esbuild-sw.js`
  - å¿˜ã‚Œãšã« package.json ã® `scripts` ã«ã‚‚è¨˜è¿°
  - ç¶šã„ã¦ push é€šçŸ¥ã®è«¸ã€…ã®å®Ÿè£…
  - ã¨ã‚Šã¾ï¼ŒWeb Push ã®å¯èƒ½æ€§ã‚’ç¢ºèª
    - `window, navigator` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ä»¥ä¸‹ãŒã‚ã‚‹ã‹ã‚’ç¢ºèª
      - `'Notification' in window`
      - `'serviceWorker' in navigator`
      - `'PushManager' in window`

- ãªãœã‹ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ Linter ã‚’å¤‰æ›´
  - VSCode ã§ format ãŒè‡ªå‹•ã§åŠ¹ã„ã¦ã„ãªã„ã®ã¨ï¼Œè©¦ã—ãŸã‹ã£ãŸ `biomejs` ã‚’ä½¿ã£ã¦ã¿ã‚‹
  - è©³ã—ãã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://biomejs.dev/ja/guides/getting-started/)

  ```bash
  > pnpm i biome -D

  # åˆæœŸåŒ–ï¼ˆã“ã‚Œã§ biome.json ãŒç”Ÿæˆã•ã‚Œã‚‹ï¼‰
  > pnpm biome init

  # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼Œãƒªãƒ³ãƒˆï¼Œä¿®æ­£ã‚’ã„ã£ãºã‚“ã«ã‚„ã‚‹ã‚³ãƒãƒ³ãƒ‰
  > pnpm biome check --apply src/**/*
  ```

  - ç°¡å˜ï¼ã™ãå‹•ãã—é€Ÿã„ğŸ‘
  - ç´°ã‹ãªãƒ«ãƒ¼ãƒ«ã¯é©å®œã‚„ã‚‹ã¨ã—ã¦ï¼Œä¸€æ—¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `tabIndex` ã«ãªã£ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ `space` ã«å¤‰æ›´ã™ã‚‹
  -

- æˆ»ã£ã¦ `FCM` ä½¿ã£ãŸ Push é€šçŸ¥ã®ç¶šã
  - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ `permission` ã‚’å–å¾—

  ```js
  	const permission = await Notification.requestPermission();

    // ã“ã£ã¡ã§ã¯ã ã‚
    // å˜ã«ä»Šã® permission ã‚’å–å¾—ã™ã‚‹ã ã‘ãªã®ã§ï¼Œã¡ã‚ƒã‚“ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èã
    const permission = Notification.permission;
  ```

  - è«¸ã€… ChatGPT ãŒæ•™ãˆã¦ãã‚Œã¦åŠ©ã‹ã‚‹ãƒ¼
  - ä¿ºã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯é€šçŸ¥ã®è¨­å®šã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ãŸã®ã§ï¼Œã¨ã‚Šã¾ `localhost:5173` ã‚’è¨±å¯ã—ãŸã‚‰ï¼Œpermission ãŒã¡ã‚ƒã‚“ã¨ `granted` ã«ãªã£ãŸ
  - service worker å‘¨ã‚Šã®å‹ãŒã‚ã‹ã‚‰ãªã„ã®ã§ï¼Œæ‚”ã—ã„ãŒ `any` ã‚’ä½¿ã†â†

  ```ts
  // â†“â†“ã“ã†ã„ã†ã‚„ã¤ã¨
  // biome-ignore lint/suspicious/noExplicitAny: <explanation>
  declare let self: any; // â† æœ¬å½“ã¯ ServiceWorkerGlobalScope ã¨æ›¸ãæ–¹è²·ã£ãŸ
  const app = initializeApp(firebaseConfig);

  // â†“â†“ã“ã†ã„ã†ã‚„ã¤
  // biome-ignore lint/suspicious/noExplicitAny: <explanation>
  self.addEventListener("activate", (event: any) => {
    event.waitUntil(self.clients.claim());
  });
  ```

  - ä»Šæ—¥ã¯ã“ã“ã§é™ç•Œã‹ã‚‚
  - ã¨ã‚Šã¾ [ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/kkeeth/pwa-sample-react) ã¯ã“ã“
  - ä¸€æ—¦ PWA ã‚¢ãƒ—ãƒªã‹ã‚‰ `granted` ã¨ç™»éŒ²ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒããŸï¼
  ![pushé€šçŸ¥ã®è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°](src/images/push_notification_confirm.png)
  ![pushé€šçŸ¥ã®è¨±å¯è¨­å®šå®Œäº†](/src/images/token_register.png)

  - å®Ÿæ©Ÿã§ã‚‚è©¦ã—ãŸã‹ã£ãŸãŒï¼Œå–å¾—ã—ãŸ `token` ã©ã†ã™ã‚‹å•é¡Œ
  - é›‘ã«ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã“ã¨ã§ãŠèŒ¶ã‚’æ¿ã™
- ã“ã“ã§çœ ãã¦çµ‚äº†